# lf-bill-java-springframework-transaction
>分布式事务使用redis，还是zookeeper
>诸葛：https://www.bilibili.com/video/BV1cV411r7Sg

## 1 分布式锁使用场景实例详解

    1.互联网秒杀下单场景
    2.抢优惠券
    3.接口幂等性校验（防重复）
    4.举例：
        看图1-01.jpg  高并发问题
        看图1-02.jpg  单体项目，解决高并发
        看图1-03.jpg  高可用的集群，nginx代理多台服务器问题，分布式锁问题，此时使用jdk自带的就无法解决高并发问题 --> 可使用jmeter测试复现超卖问题
        
##  2 分布式架构下实现分布式锁

    1.setnx key value 【存在key则报错】
    2.看图1-03.jpg
        简单分布式锁实现：设值成功获取锁，业务处理完，释放锁
            1.获取锁
            2.处理业务
            3.释放锁
        此代码问题及bug：
            1.处理业务的时候若发生异常，锁未及时释放，造成死锁问题
                [加try-catch-finally]
                2-01.jpg 
            2.集群时，部署代码的时候刚好在获取锁的时候直接被 kill -9 ，导致获取锁后，服务关闭，没有及时释放锁，集群中的其他服务由于获取不到锁，而死锁的问题
                [给锁添加超时时间]
                2-02.jpg 
            3.代码中刚获取到锁，还没来得及设置超时时间的时候宕机，导致死锁问题
                [将设值+过期时间用同一个命令实现] 【好多公司写到这里就算是写完了，不能保证100%，但是可以使用了】
                2-03.jpg
            4.以上代码中可能还是会偶尔出现超卖问题？并发不高时没问题，一旦高并发还是会有严重超卖问题【一线互联网公司】
                [由于过期时间可能会失效的问题，会出现未执行完成的线程1 最后释放了 线程2的锁，以此类推出现问题：锁永久失效，导致无锁处理业务]
                2-04.jpg
                [解决：自己的锁只能自己释放，使用uuid做value]【此时小型互联网公司就完全可以使用了】
                一般而言，能锁10s的都是大型互联网公司，执行sql慢，或者是触发了full gc导致时间长
            5.给锁设置的超时时间怎么定，太短和太长都不合适？太短可能造成业务未执行完就失效，太长万一宕机，这个锁就只能等锁失效
                [在处理业务的时候，添加定时任务，每隔一段时间，检测锁是否还在，如果还在把超时时间续期，避免未执行完就失效的问题]
                锁续期处理【此时处理的就比较完整了，不用自己写，借助开源redission】
            6.若果redis使用哨兵机制，当线程1在master获取锁后【未同步到slave，并且此时master宕机】，切换slave为主节点后，
                线程2在slave又获取到锁了，此时线程1和2又可以同时执行了，此问题怎么解决？
                看目录6,
            
## 3 redis主从架构及锁失效问题及redlock详解
## 4 基于redission框架实现分布式锁
    
    1.redission 常用于分布式锁，里面好多地方借助于lua脚本实现
    2.jedis     常用于业务
    3.使用redission
        4-01.jpg    引用依赖
        4-02.jpg    添加配置-可配置多种，单机或哨兵等
        4-03.jpg    使用，引入
        4-04.jpg    redission实现【默认30s超时时间】
    4.原理图
        4-05.jpg
        
## 6 双十一大促将分布式锁性能提升100倍
     
    1.并行改串行，出现效率问题。怎么快速提升性能？提高到几十倍 视频位置：：67:42
        使用分段锁的设计思想
        例如秒杀一个商品 productId - 1000
        可以将1000个库存分段存储
        使用时，取对应段位的 库存信息
        分段放在一个redis可以吗？不一定可以，redis是单线程，不同的用户之间还是会有争抢问题
    2.若果redis使用哨兵机制，当线程1在master获取锁后【未同步到slave，并且此时master宕机】，切换slave为主节点后，
        线程2在slave又获取到锁了，此时线程1和2又可以同时执行了，此问题怎么解决？
        。。。    
    3.redis优化问题 
